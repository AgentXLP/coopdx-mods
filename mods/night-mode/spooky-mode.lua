local pianoPlaying = false
local jumpscareTimer = -1

smlua_anim_util_register_animation("apparition_piano",
    0,
    189,
    0,
    0,
    60,
    {
		0x0000, 0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0x4000,
		0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF,
		0x0000, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
		0x0000, 0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF,
		0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0x0000, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
		0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000,
		0xFFFF, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000,
		0xFFFF, 0xFFFC, 0xFFF3, 0xFFE6, 0xFFD3, 0xFFBC, 0xFFA0, 0xFF81, 0xFF5F,
		0xFF3A, 0xFF13, 0xFEEA, 0xFEBF, 0xFE92, 0xFE65, 0xFE38, 0xFE0A, 0xFDDD,
		0xFDB1, 0xFD86, 0xFD5D, 0xFD35, 0xFD10, 0xFCEE, 0xFCCF, 0xFCB4, 0xFC9D,
		0xFC8A, 0xFC7C, 0xFC74, 0xFC71, 0xFC74, 0xFC7C, 0xFC8A, 0xFC9D, 0xFCB4,
		0xFCCF, 0xFCEE, 0xFD10, 0xFD35, 0xFD5D, 0xFD86, 0xFDB1, 0xFDDD, 0xFE0A,
		0xFE38, 0xFE65, 0xFE92, 0xFEBF, 0xFEEA, 0xFF13, 0xFF3A, 0xFF5F, 0xFF81,
		0xFFA0, 0xFFBC, 0xFFD3, 0xFFE6, 0xFFF3, 0xFFFC, 0x0000, 0xFFFF, 0x0002,
		0x0006, 0x000D, 0x0016, 0x0021, 0x002E, 0x003C, 0x004B, 0x005B, 0x006B,
		0x007B, 0x008B, 0x009A, 0x00A8, 0x00B5, 0x00C0, 0x00C9, 0x00D0, 0x00D4,
		0x00D6, 0x00D4, 0x00CD, 0x00C3, 0x00B5, 0x00A5, 0x0092, 0x007D, 0x0067,
		0x0050, 0x0039, 0x0021, 0x000A, 0xFFF3, 0xFFDF, 0xFFCC, 0xFFBB, 0xFFAE,
		0xFFA3, 0xFF9D, 0xFF9B, 0xFF9B, 0xFF9D, 0xFFA1, 0xFFA5, 0xFFAA, 0xFFB0,
		0xFFB7, 0xFFBE, 0xFFC5, 0xFFCD, 0xFFD4, 0xFFDC, 0xFFE3, 0xFFE9, 0xFFEF,
		0xFFF5, 0xFFF9, 0xFFFC, 0xFFFE, 0xFFFF, 0xFFFF, 0xFFE8, 0xFFA5, 0xFF3C,
		0xFEB2, 0xFE0B, 0xFD4B, 0xFC79, 0xFB98, 0xFAAD, 0xF9BD, 0xF8CE, 0xF7E3,
		0xF702, 0xF630, 0xF570, 0xF4C9, 0xF43F, 0xF3D6, 0xF393, 0xF37C, 0xF3A6,
		0xF420, 0xF4E0, 0xF5DD, 0xF70F, 0xF86D, 0xF9EE, 0xFB8A, 0xFD37, 0xFEED,
		0x00A4, 0x0251, 0x03ED, 0x056E, 0x06CC, 0x07FE, 0x08FB, 0x09BB, 0x0A35,
		0x0A5F, 0x0A4C, 0x0A15, 0x09BE, 0x094B, 0x08C0, 0x0822, 0x0773, 0x06B8,
		0x05F6, 0x0530, 0x0469, 0x03A7, 0x02EC, 0x023D, 0x019F, 0x0114, 0x00A1,
		0x004A, 0x0013, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFE, 0xFFFD, 0xFFFC, 0xFFFA,
		0xFFF8, 0xFFF6, 0xFFF4, 0xFFF2, 0xFFEF, 0xFFED, 0xFFEB, 0xFFE9, 0xFFE6,
		0xFFE5, 0xFFE3, 0xFFE2, 0xFFE1, 0xFFE0, 0xFFE0, 0xFFE0, 0xFFE0, 0xFFE0,
		0xFFE0, 0xFFE0, 0xFFE0, 0xFFE0, 0xFFE0, 0xFFE1, 0xFFE1, 0xFFE1, 0xFFE2,
		0xFFE2, 0xFFE3, 0xFFE4, 0xFFE4, 0xFFE5, 0xFFE6, 0xFFE7, 0xFFE8, 0xFFEA,
		0xFFEB, 0xFFEC, 0xFFEE, 0xFFEF, 0xFFF1, 0xFFF2, 0xFFF4, 0xFFF5, 0xFFF7,
		0xFFF8, 0xFFF9, 0xFFFA, 0xFFFC, 0xFFFD, 0xFFFD, 0xFFFE, 0xFFFF, 0xFFFF,
		0x0000, 0x0000, 0x0000, 0xF5E7, 0xBFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000,
		0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF,
		0x0000, 0xFFFF, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF, 0x0000, 0x0000,
		0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0xFFFF,
		0x0000, 0xFFFF, 0x4000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFF5A, 0xFDD2, 0xFBFD, 0xFA74, 0xF9CF, 0xFA1A, 0xFACC, 0xFBA1, 0xFC53,
		0xFC9E, 0xFBBB, 0xF99D, 0xF716, 0xF4F8, 0xF414, 0xF4E6, 0xF6E6, 0xF963,
		0xFBAC, 0xFD10, 0xFDA4, 0xFDFE, 0xFE2D, 0xFE3E, 0xFE40, 0xFE10, 0xFD9E,
		0xFD16, 0xFCA4, 0xFC75, 0xFDC1, 0x00D9, 0x048A, 0x07A2, 0x08EE, 0x07F9,
		0x05B2, 0x02F9, 0x00B2, 0xFFBD, 0xFFD1, 0x0002, 0x003B, 0x006B, 0x007F,
		0x0072, 0x0053, 0x002D, 0x000D, 0xFFFF, 0x050B, 0x06E0, 0x0B40, 0x1079,
		0x14D9, 0x16AE, 0x150C, 0x1127, 0x0C81, 0x089B, 0x06F9, 0x086F, 0x0BEC,
		0x1015, 0x1392, 0x1508, 0x1370, 0x0FA2, 0x0B17, 0x0749, 0x05B1, 0x06AE,
		0x090B, 0x0BDC, 0x0E39, 0x0F36, 0x0E1B, 0x0B78, 0x0852, 0x05AF, 0x0494,
		0x0628, 0x09ED, 0x0E6C, 0x1231, 0x13C6, 0x11FF, 0x0DC3, 0x08B6, 0x047A,
		0x02B4, 0x0440, 0x07F2, 0x0C5B, 0x100D, 0x119A, 0x103C, 0x0CF8, 0x0914,
		0x05D1, 0x0472, 0x0658, 0x0ADD, 0x1043, 0x14C9, 0x16AE, 0x14D9, 0x1079,
		0x0B40, 0x06E0, 0x050B, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0x00A6, 0x023C, 0x0435, 0x0605, 0x0722, 0x0782, 0x079B, 0x079D, 0x07B7,
		0x0817, 0x0901, 0x0A59, 0x0BC3, 0x0CE0, 0x0D53, 0x0BAA, 0x07AA, 0x02D1,
		0xFE9B, 0xFC87, 0xFC1A, 0xFBD9, 0xFBB7, 0xFBAB, 0xFBA9, 0xFBA8, 0xFBA0,
		0xFB8B, 0xFB62, 0xFB1F, 0xF9C9, 0xF711, 0xF3ED, 0xF156, 0xF042, 0xF0DC,
		0xF24D, 0xF405, 0xF576, 0xF610, 0xF5EC, 0xF596, 0xF52E, 0xF4D8, 0xF4B4,
		0xF5E0, 0xF8AD, 0xFC05, 0xFED2, 0xFFFF, 0xFFFF, 0xE356, 0x0000, 0x0000,
		0x0000, 0xF5E7, 0x4000, 0x0000, 0x4000, 0x0000, 0xFF61, 0xFEC3, 0xFE25,
		0xFD87, 0xFCE9, 0xFC4B, 0xFBAD, 0xFB0F, 0xFA72, 0xF9D4, 0xF5BD, 0xF1A5,
		0xED8E, 0xE977, 0xE560, 0xE77D, 0xEC86, 0xF289, 0xF792, 0xF9AF, 0xF864,
		0xF550, 0xF1A3, 0xEE8E, 0xED44, 0xEE80, 0xF172, 0xF4F6, 0xF7E8, 0xF925,
		0xF83E, 0xF619, 0xF389, 0xF164, 0xF07D, 0xF0C6, 0xF188, 0xF2A1, 0xF3EF,
		0xF54F, 0xF6A1, 0xF7CE, 0xF8BF, 0xF95F, 0xF999, 0xF8C2, 0xF6C0, 0xF45B,
		0xF25A, 0xF182, 0xF1EA, 0xF304, 0xF4A3, 0xF69C, 0xF8C1, 0xFAE6, 0xFCDE,
		0xFE7D, 0xFF97, 0x0000, 0xFAF4, 0xF9F8, 0xF8FB, 0xF7FF, 0xF702, 0xF605,
		0xF509, 0xF40C, 0xF310, 0xF213, 0xF116, 0xF2BA, 0xF45E, 0xF601, 0xF7A5,
		0xF948, 0xF813, 0xF531, 0xF1C1, 0xEEDF, 0xEDAA, 0xEEED, 0xF1EF, 0xF585,
		0xF887, 0xF9CA, 0xF86C, 0xF529, 0xF144, 0xEE01, 0xECA3, 0xEE32, 0xF1E9,
		0xF659, 0xFA10, 0xFB9F, 0xFAA9, 0xF85D, 0xF5A0, 0xF355, 0xF25F, 0xF39A,
		0xF688, 0xFA08, 0xFCF7, 0xFE32, 0xFCBE, 0xF947, 0xF525, 0xF1AE, 0xF03A,
		0xF087, 0xF158, 0xF28B, 0xF401, 0xF597, 0xF72E, 0xF8A3, 0xF9D7, 0xFAA8,
		0xFAF4, 0x0000, 0xFED2, 0xFDA4, 0xFC77, 0xFB4A, 0xFA1D, 0xF8EF, 0xF7C2,
		0xF695, 0xF568, 0xF43A, 0xF376, 0xF2B2, 0xF1ED, 0xF129, 0xF065, 0xF016,
		0xEFCD, 0xEF6C, 0xEED3, 0xEDE6, 0xEC97, 0xEB19, 0xE9B3, 0xE8AA, 0xE842,
		0xE865, 0xE8BD, 0xE930, 0xE9A3, 0xE9FB, 0xEA2A, 0xEA54, 0xEAA7, 0xEB52,
		0xEC84, 0xEFA8, 0xF519, 0xFB6F, 0x0143, 0x052B, 0x072F, 0x0869, 0x0909,
		0x0945, 0x094D, 0x07CE, 0x043D, 0xFFFA, 0xFC69, 0xFAEA, 0xFB0F, 0xFB72,
		0xFC03, 0xFCB4, 0xFD75, 0xFE35, 0xFEE6, 0xFF78, 0xFFDB, 0x0000, 0xFFFF,
		0x1CA9, 0xFFFF, 0xFFFF, 0xFFFF, 0x0002, 0x0008, 0x0011, 0x001D, 0x002C,
		0x003E, 0x0052, 0x0068, 0x0080, 0x009A, 0x00B5, 0x00D1, 0x00EE, 0x010B,
		0x0129, 0x0146, 0x0164, 0x0180, 0x019C, 0x01B7, 0x01D1, 0x01E9, 0x01FF,
		0x0214, 0x0225, 0x0234, 0x0241, 0x024A, 0x024F, 0x0251, 0x024F, 0x024A,
		0x0241, 0x0234, 0x0225, 0x0214, 0x01FF, 0x01E9, 0x01D1, 0x01B7, 0x019C,
		0x0180, 0x0164, 0x0146, 0x0129, 0x010B, 0x00EE, 0x00D1, 0x00B5, 0x009A,
		0x0080, 0x0068, 0x0052, 0x003E, 0x002C, 0x001D, 0x0011, 0x0008, 0x0002,
		0xFFFF, 0xBFFF, 0xFFFF, 0x0000, 0x7FFF, 0x0000, 0xFFFF, 0x4000, 0xFFFF,
		0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000,
		0x0000, 0x0000, 0x0000, 0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
		0x0000, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF, 0xFFFF,
		0xFFFF, 0x0000, 0xCE38, 0xCC2B, 0xC746, 0xC16F, 0xBC8B, 0xBA7D, 0xBC8B,
		0xC16F, 0xC746, 0xCC2B, 0xCE38, 0xCE38, 0xCE38, 0xCE38, 0xCE38, 0xCE38,
		0xCC2B, 0xC746, 0xC16F, 0xBC8B, 0xBA7D, 0xBC8B, 0xC16F, 0xC746, 0xCC2B,
		0xCE38, 0xCE38, 0xCE38, 0xCE38, 0xCE38, 0xCE38, 0xCC2B, 0xC746, 0xC16F,
		0xBC8B, 0xBA7D, 0xBC8B, 0xC16F, 0xC746, 0xCC2B, 0xCE38, 0xCE38, 0xCE38,
		0xCE38, 0xCE38, 0xCE38, 0xCC2B, 0xC746, 0xC16F, 0xBC8B, 0xBA7D, 0xBC8B,
		0xC16F, 0xC746, 0xCC2B, 0xCE38, 0xFFFF, 0xFFFF, 0xFFFD, 0xFFF8, 0xFFF0,
		0xFFE4, 0xFFD7, 0xFFC6, 0xFFB4, 0xFF9F, 0xFF89, 0xFF71, 0xFF59, 0xFF3F,
		0xFF24, 0xFF09, 0xFEEE, 0xFED3, 0xFEB8, 0xFE9D, 0xFE83, 0xFE6A, 0xFE53,
		0xFE3D, 0xFE28, 0xFE16, 0xFE05, 0xFDF7, 0xFDEC, 0xFDE4, 0xFDDF, 0xFDDD,
		0xFDDF, 0xFDE4, 0xFDEC, 0xFDF7, 0xFE05, 0xFE16, 0xFE28, 0xFE3D, 0xFE53,
		0xFE6A, 0xFE83, 0xFE9D, 0xFEB8, 0xFED3, 0xFEEE, 0xFF09, 0xFF24, 0xFF3F,
		0xFF59, 0xFF71, 0xFF89, 0xFF9F, 0xFFB4, 0xFFC6, 0xFFD7, 0xFFE4, 0xFFF0,
		0xFFF8, 0xFFFD, 0xFFFF, 0xBFFF, 0xFFFF, 0x0000, 0x7FFF, 0x0000, 0x001A,
		0x0060, 0x00C7, 0x0144, 0x01CC, 0x0254, 0x02D1, 0x0338, 0x037E, 0x0398,
		0x0397, 0x0393, 0x038E, 0x0387, 0x037E, 0x0373, 0x0367, 0x0359, 0x0349,
		0x0338, 0x0326, 0x0312, 0x02FE, 0x02E8, 0x02D1, 0x02B9, 0x02A1, 0x0288,
		0x026E, 0x0254, 0x0239, 0x021E, 0x0203, 0x01E7, 0x01CC, 0x01B0, 0x0195,
		0x0179, 0x015E, 0x0144, 0x012A, 0x0110, 0x00F7, 0x00DE, 0x00C7, 0x00B0,
		0x009A, 0x0086, 0x0072, 0x0060, 0x004F, 0x003F, 0x0031, 0x0025, 0x001A,
		0x0011, 0x000A, 0x0004, 0x0001, 0x0000, 0xFFFF, 0x4000, 0xFFFF, 0x0001,
		0x0005, 0x000B, 0x0013, 0x001C, 0x0028, 0x0035, 0x0043, 0x0053, 0x0063,
		0x0075, 0x0087, 0x009A, 0x00AD, 0x00C0, 0x00D3, 0x00E6, 0x00F9, 0x010B,
		0x011C, 0x012D, 0x013C, 0x014B, 0x0158, 0x0163, 0x016D, 0x0175, 0x017B,
		0x017E, 0x0180, 0x017E, 0x017B, 0x0175, 0x016D, 0x0163, 0x0158, 0x014B,
		0x013C, 0x012D, 0x011C, 0x010B, 0x00F9, 0x00E6, 0x00D3, 0x00C0, 0x00AD,
		0x009A, 0x0087, 0x0075, 0x0063, 0x0053, 0x0043, 0x0035, 0x0028, 0x001C,
		0x0013, 0x000B, 0x0005, 0x0001, 0xFFFF, 0x0000, 0x0003, 0x000D, 0x001C,
		0x0031, 0x004B, 0x0069, 0x008B, 0x00B1, 0x00DA, 0x0106, 0x0133, 0x0163,
		0x0194, 0x01C6, 0x01F8, 0x022B, 0x025D, 0x028E, 0x02BD, 0x02EB, 0x0317,
		0x0340, 0x0366, 0x0388, 0x03A6, 0x03C0, 0x03D5, 0x03E4, 0x03EE, 0x03F1,
		0x03EE, 0x03E4, 0x03D5, 0x03C0, 0x03A6, 0x0388, 0x0366, 0x0340, 0x0317,
		0x02EB, 0x02BD, 0x028E, 0x025D, 0x022B, 0x01F8, 0x01C6, 0x0194, 0x0163,
		0x0133, 0x0106, 0x00DA, 0x00B1, 0x008B, 0x0069, 0x004B, 0x0031, 0x001C,
		0x000D, 0x0003, 0x0000, 0xCE38, 0xCE38, 0xCE38, 0xCE39, 0xCE39, 0xCE39,
		0xCE3A, 0xCE3B, 0xCE3B, 0xCE3C, 0xCE3D, 0xCE3E, 0xCE3F, 0xCE40, 0xCE40,
		0xCE41, 0xCE42, 0xCE43, 0xCE44, 0xCE45, 0xCE46, 0xCE47, 0xCE47, 0xCE48,
		0xCE49, 0xCE49, 0xCE4A, 0xCE4A, 0xCE4A, 0xCE4B, 0xCE4B, 0xCE4B, 0xCE4A,
		0xCE4A, 0xCE4A, 0xCE49, 0xCE49, 0xCE48, 0xCE47, 0xCE47, 0xCE46, 0xCE45,
		0xCE44, 0xCE43, 0xCE42, 0xCE41, 0xCE40, 0xCE40, 0xCE3F, 0xCE3E, 0xCE3D,
		0xCE3C, 0xCE3B, 0xCE3B, 0xCE3A, 0xCE39, 0xCE39, 0xCE39, 0xCE38,
    },
    {
		0x0001, 0x0000, 0x0001, 0x0001, 0x0001, 0x0002, 0x0001, 0x0003, 0x0001,
		0x0004, 0x0001, 0x0005, 0x0001, 0x0006, 0x0001, 0x0007, 0x0001, 0x0008,
		0x001D, 0x0009, 0x003D, 0x0026, 0x003D, 0x0063, 0x003D, 0x00A0, 0x003D,
		0x00DD, 0x003D, 0x011A, 0x0001, 0x0157, 0x0001, 0x0158, 0x0001, 0x0159,
		0x0001, 0x015A, 0x003C, 0x015B, 0x0001, 0x0197, 0x0038, 0x0198, 0x003D,
		0x01D0, 0x0038, 0x020D, 0x0001, 0x0245, 0x0001, 0x0246, 0x0001, 0x0247,
		0x0001, 0x0248, 0x0001, 0x0249, 0x0001, 0x024A, 0x0001, 0x024B, 0x0001,
		0x024C, 0x0001, 0x024D, 0x003D, 0x024E, 0x003D, 0x028B, 0x003D, 0x02C8,
		0x0001, 0x0305, 0x0001, 0x0306, 0x0001, 0x0307, 0x0001, 0x0308, 0x003D,
		0x0309, 0x0001, 0x0346, 0x0001, 0x0347, 0x0001, 0x0348, 0x0001, 0x0349,
		0x0001, 0x034A, 0x0001, 0x034B, 0x0001, 0x034C, 0x0001, 0x034D, 0x0038,
		0x034E, 0x0038, 0x0386, 0x0001, 0x03BE, 0x003D, 0x03BF, 0x0001, 0x03FC,
		0x0001, 0x03FD, 0x0001, 0x03FE, 0x0001, 0x03FF, 0x003D, 0x0400, 0x0001,
		0x043D, 0x0001, 0x043E, 0x003D, 0x043F, 0x003D, 0x047C, 0x003B, 0x04B9,
    }
)

function stub() end

--- @param o Object
function bhv_custom_piano_loop(o)
    if not gGlobalSyncTable.spookyMode and o.oAction ~= 99 then
        bhv_mad_piano_update()
        return
    end

    o.oAction = 99

    cur_obj_init_animation_with_sound(0)
    cur_obj_push_mario_away_from_cylinder(280, 150)
end


--- @param o Object
function bhv_nm_apparition_loop(o)
    local flashlight = obj_get_nearest_object_with_behavior_id(o, bhvNMFlashlight)
    if (flashlight ~= nil and dist_between_objects(o, flashlight) < 2000) then
        cur_obj_hide()
        if pianoPlaying then
            audio_stream_pause(STREAM_PIANO)
            fade_volume_scale(SEQ_PLAYER_LEVEL, 127, 1)
            pianoPlaying = false
        end
        return
    else
        cur_obj_unhide()
        if not pianoPlaying then
            audio_stream_play(STREAM_PIANO, false, 0.0)
            pianoPlaying = true
        end
    end

    local dist = dist_between_objects(o, gMarioStates[0].marioObj)
    local volume = math.clamp(600 / dist, 0, 1)
    audio_stream_set_volume(STREAM_PIANO, volume)
    fade_volume_scale(SEQ_PLAYER_LEVEL, (1 - volume) * 127, 1)

    if dist < 300 and gMarioStates[0].action ~= ACT_DISAPPEARED then
        jumpscareTimer = 0
        set_mario_action(gMarioStates[0], ACT_DISAPPEARED, 0)
        sound_banks_disable(SEQ_PLAYER_SFX, SOUND_BANKS_ALL)
        audio_stream_stop(STREAM_PIANO)
        level_trigger_warp(gMarioStates[0], WARP_OP_DEATH)
    end

    smlua_anim_util_set_animation(o, "apparition_piano")
end


function spooky_mode_on_level_init()
    audio_stream_stop(STREAM_PIANO)
    pianoPlaying = false

    if not gGlobalSyncTable.spookyMode then return end

    if in_vanilla_level(LEVEL_BBH) then
        audio_stream_play(STREAM_PIANO, true, 0.0)
        audio_stream_set_looping(STREAM_PIANO, true)
        pianoPlaying = true

		local apparition = spawn_object(
			bhvNMApparition,
			E_MODEL_NM_APPARITION,
			-1530, 50, 2200
		)
		apparition.oFaceAngleYaw = 0x7000
    end
end

function spooky_mode_on_hud_render()
    if jumpscareTimer >= 60 then
        sound_banks_enable(SEQ_PLAYER_SFX, SOUND_BANKS_ALL)
        jumpscareTimer = -1
    end
    if jumpscareTimer == -1 then return end

    if jumpscareTimer == 5 then
        audio_sample_play(SAMPLE_JUMPSCARE, gMarioStates[0].pos, 1.0)
    end

    djui_hud_set_resolution(RESOLUTION_DJUI)
    djui_hud_set_filter(FILTER_LINEAR)

    local width = djui_hud_get_screen_width()
    local height = djui_hud_get_screen_height()

    if jumpscareTimer < 29 then
        djui_hud_set_color(255, 255, 255, 255)
        djui_hud_render_texture(get_texture_info(string.format("nm_jumpscare_%02d", jumpscareTimer + 1)), 0, 0, width / 1024, height / 512)
    else
        djui_hud_set_color(0, 0, 0, 255)
        djui_hud_render_rect(0, 0, width, height)
    end

    jumpscareTimer = jumpscareTimer + 1
end

-- gLevelValues.entryLevel = LEVEL_BBH

hook_event(HOOK_ON_HUD_RENDER, spooky_mode_on_hud_render)